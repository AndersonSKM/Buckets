sudo: required
dist: trusty
group: edg

services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.16.1

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - echo "DEBUG=$DEBUG" >> .env
  - echo "SECRET_KEY=$SECRET_KEY" >> .env
  - echo "USER_ACTIVATION_URI=$USER_ACTIVATION_URI" >> .env
  - echo "USER_PASSWORD_RESET_URI=$USER_PASSWORD_RESET_URI" >> .env
  - echo "DATABASE_URL=$DATABASE_URL" >> .env
  - echo "REDIS_URL=$REDIS_URL" >> .env

  - echo "CODECOV_TOKEN=$CODECOV_TOKEN" >> .env
  - echo "CI=$CI" >> env
  - echo "TRAVIS=$TRAVIS" >> env
  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH" >> .env
  - echo "TRAVIS_COMMIT=$TRAVIS_COMMIT" >> .env
  - echo "TRAVIS_JOB_ID=$TRAVIS_JOB_ID" >> .env
  - echo "TRAVIS_JOB_NUMBER=$TRAVIS_JOB_NUMBER" >> .env
  - echo "TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST" >> .env
  - echo "TRAVIS_TAG=$TRAVIS_TAG" >> .env
  - echo "TRAVIS_OS_NAME=$TRAVIS_OS_NAME" >> .env
  - echo "TRAVIS_REPO_SLUG=$TRAVIS_REPO_SLUG" >> .env
  - export TAG=${TRAVIS_COMMIT::8}

jobs:
  include:
    - stage: Build docker images
      script: make api-build && make push-api-image
      language: python
      python:
        - "3.6"
    - script: make client-build && make push-client-image
      language: node
      node_js:
        - "8"
    - stage: Tests
      script: make up && make api-test && make api-coverage
      language: python
      python:
        - "3.6"
    - script: make up && make client-test
      language: node
      node_js:
        - "8"
